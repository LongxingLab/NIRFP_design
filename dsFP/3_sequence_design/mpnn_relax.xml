<ROSETTASCRIPTS>

<SCOREFXNS>
	<ScoreFunction name="sfxn"  weights="beta_nov16.wts" />
	<ScoreFunction name="sfxn_std"  weights="beta_nov16.wts">
		<Reweight scoretype="approximate_buried_unsat_penalty" weight="5.0" />
                <Set approximate_buried_unsat_penalty_burial_atomic_depth="3.5"/>
                Reweight scoretype="atom_pair_constraint" weight="2.0" />
                Reweight scoretype="angle_constraint" weight="1.0" />
                Reweight scoretype="dihedral_constraint" weight="1.0" />
                Reweight scoretype="coordinate_constraint" weight="1.0" />
                Reweight scoretype="res_type_constraint" weight="1.5" />
                <Reweight scoretype="aa_composition" weight="1.0" />
	</ScoreFunction>
</SCOREFXNS>

<RESIDUE_SELECTORS>

    <True name="full_pose" />

    <ResidueName name="FDI" residue_name3="FDI" />
    <Not name="L_caa" selector="FDI" />

    <!-- Layer Design -->
    <Index name="Nter" resnums="1" error_on_out_of_bounds_index="true" reverse="false" />
    <Index name="Cter" resnums="1" error_on_out_of_bounds_index="true" reverse="true" />
    <Layer name="surface" select_core="false" select_boundary="false" select_surface="true" use_sidechain_neighbors="true"/>
    <Layer name="boundary" select_core="false" select_boundary="true" select_surface="false" use_sidechain_neighbors="true"/>
    <Layer name="core" select_core="true" select_boundary="false" select_surface="false" use_sidechain_neighbors="true"/>
    <SecondaryStructure name="sheet" overlap="0" minH="3" minE="2" include_terminal_loops="false" use_dssp="true" ss="E"/>
    <SecondaryStructure name="entire_loop" overlap="0" minH="3" minE="2" include_terminal_loops="false" use_dssp="true" ss="L"/> # exclude terminal loops so that I can use index selector to select that.
    <SecondaryStructure name="entire_helix" overlap="0" minH="3" minE="2" include_terminal_loops="false" use_dssp="true" ss="H"/>
    <And name="helix_cap" selectors="entire_loop">
        <PrimarySequenceNeighborhood lower="1" upper="0" selector="entire_helix"/>
    </And>
    <And name="helix_start" selectors="entire_helix">
        <PrimarySequenceNeighborhood lower="0" upper="1" selector="helix_cap"/>
    </And>
    <And name="helix" selectors="entire_helix">
        <Not selector="helix_start"/>
    </And>
    <And name="loop" selectors="entire_loop">
        <Not selector="helix_cap"/>
    </And>

</RESIDUE_SELECTORS>

<TASKOPERATIONS>
	<DesignRestrictions name="layer_design">
            <Action selector_logic="Nter AND L_caa" aas="ADEFGHIKLNPQRSTVWY" />
            <Action selector_logic="Cter AND L_caa" aas="ADEFGHIKLNPQRSTVWY" />

            <Action selector_logic="surface AND helix_start AND L_caa"    aas="DEHKPQR"/>
            <Action selector_logic="surface AND helix AND L_caa"          aas="EHKQR"/>
            <Action selector_logic="surface AND sheet AND L_caa"          aas="EHKNQRST"/>
            <Action selector_logic="surface AND loop AND L_caa"           aas="DEGHKNPQRST"/>
            <Action selector_logic="boundary AND helix_start AND L_caa"   aas="ADEHIKLNPQRSTVWY"/>
            <Action selector_logic="boundary AND helix AND L_caa"         aas="ADEFHIMKLNQRSTVWY"/> # adding Phe(20190612)
            <Action selector_logic="boundary AND sheet AND L_caa"         aas="DEFHIKLMNQRSTVWY"/>
            <Action selector_logic="boundary AND loop AND L_caa"          aas="ADEFGHIKLNPQRSTVWY"/>
            <Action selector_logic="core AND helix_start AND L_caa"               aas="AFILPVWYSTHDENQ"/>
            <Action selector_logic="core AND helix AND L_caa"                     aas="AFILVWYMSTHDENQ"/>
            <Action selector_logic="core AND sheet AND L_caa"                     aas="FILVWYMSTHDENQ"/>
            <Action selector_logic="core AND loop AND L_caa"                      aas="AFGILPVWYMSTHDENQ"/>
            <Action selector_logic="helix_cap AND L_caa"                  aas="DNST"/>
    </DesignRestrictions>
</TASKOPERATIONS>

<FILTERS>
	# score per residue
	<ResidueCount name="res_count_all" max_residue_count="9999" confidence="0"/>
	<ScoreType name="total_score" scorefxn="sfxn_std" threshold="0"/>
	<CalculatorFilter name="score_per_res" equation="total_score / res" threshold="-2.5" confidence="0">
		<Var name="total_score" filter="total_score"/>
		<Var name="res" filter="res_count_all"/>
	</CalculatorFilter>

	<ScoreType name="fa_atr" scorefxn="sfxn_std" threshold="0" score_type="fa_atr" />
	<CalculatorFilter name="fa_atr_per_res" equation="fa_atr_score / res" threshold="-5.2" confidence="0">
		<Var name="fa_atr_score" filter="fa_atr"/>
		<Var name="res" filter="res_count_all"/>
	</CalculatorFilter>

	<Holes name="holes" confidence="0"/>


	BuriedUnsatHbonds name="buns_heavy_ball_1.1D" use_reporter_behavior="true" report_all_heavy_atom_unsats="true" scorefxn="sfxn" ignore_surface_res="true" print_out_info_to_pdb="true" confidence="0" use_ddG_style="false" burial_cutoff="0.01" dalphaball_sasa="true" probe_radius="1.1" max_hbond_energy="1.5" />
        BuriedUnsatHbonds name="sbuns5.0_heavy_ball_1.1D" use_reporter_behavior="true" report_all_heavy_atom_unsats="true" scorefxn="sfxn" ignore_surface_res="true" print_out_info_to_pdb="true" confidence="0" use_ddG_style="false" burial_cutoff="0.01" dalphaball_sasa="true" probe_radius="1.1" atomic_depth_selection="5.0" atomic_depth_deeper_than="false" atomic_depth_resolution="0.49" max_hbond_energy="1.5"/>
        BuriedUnsatHbonds name="vbuns5.0_heavy_ball_1.1D" use_reporter_behavior="true" report_all_heavy_atom_unsats="true" scorefxn="sfxn" ignore_surface_res="true" print_out_info_to_pdb="true" confidence="0" use_ddG_style="false" dalphaball_sasa="true" probe_radius="1.1" atomic_depth_selection="5.0" burial_cutoff="1000" atomic_depth_resolution="0.49" max_hbond_energy="1.5"/>

	<SSShapeComplementarity name="ss_sc" verbose="0" confidence="0" />
	<SSShapeComplementarity name="helix_sc" verbose="1" loops="0" helices="1" confidence="0" />
	<SSShapeComplementarity name="loop_sc" verbose="1" loops="1" helices="0" confidence="0" />

	SSPrediction name="mismatch_probability" confidence="0" cmd="/storage/caolongxingLab/software/psipred/runpsipred_single" use_probability="1" mismatch_probability="1" use_svm="0" />
</FILTERS>

<TASKOPERATIONS>
	<InitializeFromCommandline name="init"/>
    <IncludeCurrent name="current" />
    <ExtraRotamersGeneric name="ex1" ex1="1" />
    <ExtraRotamersGeneric name="ex1_ex2" ex1="1" ex2aro="1" />
    <LimitAromaChi2 name="limitchi2" chi2max="110" chi2min="70" include_trp="True" />
    <ConsensusLoopDesign name="consensus_loop" include_adjacent_residues="True" />

    <OperateOnResidueSubset name="restrict_repacking" selector="full_pose">
	<RestrictToRepackingRLT/>
    </OperateOnResidueSubset>

    <OperateOnResidueSubset name="restrict_FDI" selector="FDI">
        <RestrictToRepackingRLT/>
    </OperateOnResidueSubset>

</TASKOPERATIONS>

<MOVERS>
	<Dssp name="dssp" />

	 <AddCompositionConstraintMover name="add_aa_composition">
            <Comp entry="PENALTY_DEFINITION;TYPE ALA;ABSOLUTE 0;PENALTIES 0 2;DELTA_START 0;DELTA_END 1;BEFORE_FUNCTION CONSTANT;AFTER_FUNCTION LINEAR;END_PENALTY_DEFINITION;"/>
	    <Comp entry="PENALTY_DEFINITION;TYPE MET;ABSOLUTE 0;PENALTIES 0 1;DELTA_START 0;DELTA_END 1;BEFORE_FUNCTION CONSTANT;AFTER_FUNCTION LINEAR;END_PENALTY_DEFINITION;"/>
	    <Comp entry="PENALTY_DEFINITION;TYPE TRP;ABSOLUTE 0;PENALTIES 0 1;DELTA_START 0;DELTA_END 1;BEFORE_FUNCTION CONSTANT;AFTER_FUNCTION LINEAR;END_PENALTY_DEFINITION;"/>
        </AddCompositionConstraintMover>
        <ClearCompositionConstraintsMover name="clear_aa_composition" />


	PackRotamersMover name="pack" scorefxn="sfxn_std" task_operations="init,limitchi2,ex1_ex2,restrict_repacking"/>
	<FastDesign name="fastdes" task_operations="init,current,ex1,ex1_ex2,limitchi2,consensus_loop,layer_design,restrict_FDI" scorefxn="sfxn_std" relaxscript="MonomerDesign2019" clear_designable_residues="0" repeats="1" ramp_down_constraints="0" />

	<FastRelax name="fastrelax" task_operations="init,current,ex1,ex1_ex2,limitchi2,restrict_FDI" scorefxn="sfxn_std" repeats="1" batch="false" ramp_down_constraints="false" cartesian="false" bondangle="false" bondlength="false" min_type="dfpmin_armijo_nonmonotone" />
</MOVERS>

<PROTOCOLS>
	<Add mover_name="dssp" />
	Add mover_name="pack" />
	<Add mover_name="add_aa_composition" />
	<Add mover_name="fastdes" />
	<Add mover_name="clear_aa_composition" />

	# score
	<Add filter_name="score_per_res" />
	Add filter="fa_atr_per_res" />

	# ss packing
	Add filter_name="ss_sc" />
	Add filter_name="helix_sc" />
	Add filter_name="loop_sc" />

	Add filter_name="holes" />

        Add filter="vbuns5.0_heavy_ball_1.1D" />
        Add filter="sbuns5.0_heavy_ball_1.1D" />
        Add filter="buns_heavy_ball_1.1D" />

	# secondary aggrement
	Add filter_name="mismatch_probability" />
</PROTOCOLS>

</ROSETTASCRIPTS>
